---
title: "Evolution of solar energy production and use."
author: "Laia Porcar, Luis Marcos LÃ³pez, Philippe Robert"
date: "11/08/2022"
output:
  html_document:
    keep_md: yes
    toc: yes
    df_print: kable
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(warn=-1)
```


```{r, results="hide", message = FALSE}
# Installs
#install.packages("caret")
#install.packages("car")
#install.packages("ggplot2")
#install.packages("devtools")


# Libraries
library(knitr)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(ggcorrplot)
library(devtools) 
library(caret)
library(car)
library(kableExtra)
library(ggpubr)
library(readxl)
library(lmtest) 
library(forecast)
library(DIMORA)

```



```{r results = 'asis'}
# Read the dataset
file_path <- getwd()
paste(file_path)

df_capac <- read.csv(paste0(file_path, "/installed-solar-PV-capacity.csv"),header=TRUE)
df_capit <- read.csv(paste0(file_path, "/per-capita-solar.csv"),header=TRUE)
df_prim <- read.csv(paste0(file_path, "/primary-energy-consumption-from-solar.csv"),header=TRUE)
df_shar <- read.csv(paste0(file_path, "/share-electricity-solar.csv"),header=TRUE)
df_consump <- read.csv(paste0(file_path, "/solar-energy-consumption.csv"),header=TRUE)
df_cumcapac <- read.csv(paste0(file_path, "/solar-pv-cumulative-capacity.csv"),header=TRUE)
df_price <- read.csv(paste0(file_path, "/solar-pv-prices.csv"),header=TRUE)
df_totconsumpcapita <- read.csv(paste0(file_path, "/per-capita-energy.csv"), header=TRUE)


df_capac[1:150,] %>%
  kable(format = "html", col.names = colnames(df_capac)) %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "300px")

df_capit[1:150,] %>%
  kable(format = "html", col.names = colnames(df_capit)) %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "300px")

df_prim[1:150,] %>%
  kable(format = "html", col.names = colnames(df_prim)) %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "300px")

df_shar[1:150,] %>%
  kable(format = "html", col.names = colnames(df_shar)) %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "300px")

df_consump[1:150,] %>%
  kable(format = "html", col.names = colnames(df_consump)) %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "300px")

df_cumcapac[1:150,] %>%
  kable(format = "html", col.names = colnames(df_cumcapac)) %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "300px")

df_price[1:150,] %>%
  kable(format = "html", col.names = colnames(df_pris)) %>%
  kable_styling() %>%
  kableExtra::scroll_box(width = "100%", height = "300px")

df_totconsumpcapita[1:150,] %>% 
  kable(format = "html", col.names = colnames(df_totconsumpcapita)) %>% 
  kable_styling() %>% 
  kableExtra::scroll_box(width = "100%", height = "300ppx")

```


```{r results = 'asis'}

entity <- 'Spain'

df_capacity <- df_capac %>% filter(Entity == entity) %>% select(-c(Entity, Code))
df_capita <- df_capit %>% filter(Entity == entity) %>% select(-c(Entity, Code))
df_primary <- df_prim %>% filter(Entity == entity) %>% select(-c(Entity, Code))
df_share <- df_shar %>% filter(Entity == entity) %>% select(-c(Entity, Code))
df_consumption <- df_consump %>% filter(Entity == entity) %>% select(-c(Entity, Code))
df_cumcap <- df_cumcapac %>% filter(Entity == entity) %>% select(-c(Entity, Code))
df_totconsump <- df_totconsumpcapita %>% filter(Entity == entity) %>% select(-c(Entity, Code))
# df_price <- select(df_price,-c(Entity, Code))

df <- merge(df_capacity,df_capita, by="Year", all = TRUE)
df <- merge(df,df_primary,by="Year", all = TRUE)
df <- merge(df,df_share,by="Year", all = TRUE)
df <- merge(df,df_consumption,by="Year", all = TRUE)
df <- merge(df,df_cumcap,by="Year", all = TRUE)
df <- merge(df,df_price,by="Year", all = TRUE)
df <- merge(df,df_totconsump,by="Year", all = TRUE)

df[is.na(df)] <- 0


```




# Exploratory data analysis


# Apply stuff from the lectures


```{r results = 'asis'}

str(df)


```


```{r results = 'asis'}


cap_consump <- df$Solar.per.capita..kWh...equivalent[25:57]
tt<- 1:NROW(cap_consump)

plot(tt, cap_consump, xlab="Time", ylab="Solar per capita kWh")
# acf(cap_consump)

```




```{r results = 'asis'}

##fit a linear regression model 
fit1 <- lm(cap_consump ~ tt)
summary(fit1)

##plot of the model
plot(tt, cap_consump, xlab="Time", ylab="Solar per capita kWh")
abline(fit1, col=3)

##check the residuals? are they autocorrelated? Test of DW
dwtest(fit1)

##check the residuals
resfit1<- residuals(fit1)
plot(resfit1,xlab="Time", ylab="residuals" )


```



```{r results = 'asis'}

##let us do the same with a linear model for time series, so we transform the data into a ts object
cap_consump.ts <- ts(cap_consump, frequency = 4)
ts.plot(cap_consump.ts, type="o")

## we fit a linear model with the tslm function
fitts<- tslm(cap_consump.ts~trend)

###obviously it gives the same results of the first model
summary(fitts)

dwtest(fitts)

```



```{r results = 'asis'}

plot(cumsum(cap_consump), type="b")

```



```{r results = 'asis'}

bm_cap<-BM(cap_consump,display = T)
summary(bm_cap)

```

