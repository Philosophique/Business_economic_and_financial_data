---
title: "Evolution of solar energy production and use."
author: "Laia Porcar, Luis Marcos LÃ³pez, Philippe Robert"
date: "11/08/2022"
output:
  html_document:
    keep_md: yes
    toc: yes
    df_print: kable
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(warn=-1)

```



```{r, results="hide", message = FALSE}
# Installs
# install.packages("caret")
# install.packages("car")
# install.packages("ggplot2")
# install.packages("devtools")  


# Libraries
library(knitr)
library(tidyverse)
library(ggplot2)
library(scales)
library(dplyr)
library(ggcorrplot)
library(devtools) 
library(caret)
library(car)
library(kableExtra)
library(ggpubr)
library(readxl)
library(lmtest) 
library(forecast)
library(DIMORA)
library(reshape2)
library(zoo)
library(sm)
library(splines)
library(gam)
library(tree)
library(gbm)
library(randomForest)
library(forecast)


```

# Read and prepare datasets

```{r Read dataset, results=}
# Read the dataset
file_path <- getwd()
paste(file_path)


# Per capita energy consumption from solar
df_capita_solar <- read.csv(paste0(file_path, "/per-capita-solar.csv"),header=TRUE)
# Solar PV module prices
df_price <- read.csv(paste0(file_path, "/solar-pv-prices.csv"),header=TRUE)
# Share of electricity production from solar
df_share <- read.csv(paste0(file_path, "/share-electricity-solar.csv"),header=TRUE)
# Installed solar energy capacity
df_capacity <- read.csv(paste0(file_path, "/installed-solar-PV-capacity.csv"),header=TRUE)
# Per capita energy consumption from nuclear
df_capita_nuclear <- read.csv(paste0(file_path, "/per-capita-nuclear.csv"),header=TRUE)
# Per capita energy consumption from wind
df_capita_wind <- read.csv(paste0(file_path, "/per-capita-wind.csv"),header=TRUE)
# Per capita energy consumption from fossil
df_capita_fossil <- read.csv(paste0(file_path, "/fossil-fuels-per-capita.csv"),header=TRUE)
# Per capita energy consumption from oil
df_capita_oil <- read.csv(paste0(file_path, "/per-capita-oil.csv"),header=TRUE)
# Per capita energy consumption from gas
df_capita_gas <- read.csv(paste0(file_path, "/per-capita-gas.csv"),header=TRUE)
# Per capita energy consumption from coal
df_capita_coal <- read.csv(paste0(file_path, "/coal-consumption-per-capita.csv"),header=TRUE)
# solar power generation
df_solar_generation <- read.csv(paste0(file_path, "/solar-energy-consumption.csv"),header=TRUE)


```


```{r df names creation, results=}

entity <- 'Spain'



share <- df_share %>% filter(Entity == entity) %>% select(-c(Entity, Code))
price <- select(df_price,-c(Entity, Code))
capacity <- df_capacity %>% filter(Entity == entity) %>% select(-c(Entity, Code))

capita_solar_spain <- df_capita_solar %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_nuclear <- df_capita_nuclear %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_wind <- df_capita_wind %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_fossil <- df_capita_fossil %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_gas <- df_capita_gas %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_oil <- df_capita_oil %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_coal <- df_capita_coal %>% filter(Entity == entity) %>% select(-c(Entity, Code))

capita_solar_germany <- df_capita_solar %>% filter(Entity == 'Germany') %>% select(-c(Entity, Code))
capita_solar_usa <- df_capita_solar %>% filter(Entity == 'United States') %>% select(-c(Entity, Code))
capita_solar_china <- df_capita_solar %>% filter(Entity == 'China') %>% select(-c(Entity, Code))
capita_solar_australia <- df_capita_solar %>% filter(Entity == 'Australia') %>% select(-c(Entity, Code))
capita_solar_india <- df_capita_solar %>% filter(Entity == 'Australia') %>% select(-c(Entity, Code))
capita_solar_world <- df_capita_solar %>% filter(Entity == 'World') %>% select(-c(Entity, Code))

solar_generation_spain <- df_solar_generation %>% filter(Entity == entity) %>% select(-c(Entity, Code))
solar_generation_germany <- df_solar_generation %>% filter(Entity == 'Germany') %>% select(-c(Entity, Code))
solar_generation_usa <- df_solar_generation %>% filter(Entity == 'United States') %>% select(-c(Entity, Code))
solar_generation_china <- df_solar_generation %>% filter(Entity == 'China') %>% select(-c(Entity, Code))
solar_generation_australia <- df_solar_generation %>% filter(Entity == 'Australia') %>% select(-c(Entity, Code))
solar_generation_india <- df_solar_generation %>% filter(Entity == 'India') %>% select(-c(Entity, Code))
solar_generation_world <- df_solar_generation %>% filter(Entity == 'World') %>% select(-c(Entity, Code))



df <- merge(share, capacity, by="Year", all = TRUE) #to fill the non existent values with NA
df <- merge(df,price,by="Year", all = TRUE)
df <- merge(df,capita_solar_spain,by="Year", all = TRUE)
df <- merge(df,capita_nuclear,by="Year", all = TRUE)
df <- merge(df,capita_wind,by="Year", all = TRUE)
df <- merge(df,capita_coal,by="Year", all = TRUE)
df <- merge(df,capita_fossil,by="Year", all = TRUE)
df <- merge(df,capita_gas,by="Year", all = TRUE)
df <- merge(df,capita_oil,by="Year", all = TRUE)
df <- merge(df,capita_solar_germany,by="Year", all = TRUE)
df <- merge(df,capita_solar_usa,by="Year", all = TRUE)
df <- merge(df,capita_solar_china,by="Year", all = TRUE)
df <- merge(df,capita_solar_australia,by="Year", all = TRUE)
df <- merge(df,capita_solar_india,by="Year", all = TRUE)
df <- merge(df,capita_solar_world,by="Year", all = TRUE)
df <- merge(df,solar_generation_spain,by="Year", all = TRUE)
df <- merge(df,solar_generation_germany,by="Year", all = TRUE)
df <- merge(df,solar_generation_usa,by="Year", all = TRUE)
df <- merge(df,solar_generation_china,by="Year", all = TRUE)
df <- merge(df,solar_generation_australia,by="Year", all = TRUE)
df <- merge(df,solar_generation_india,by="Year", all = TRUE)
df <- merge(df,solar_generation_world,by="Year", all = TRUE)

df[is.na(df)] <- 0 #change NA to 0

# # # Change names of columns
colnames(df) <- c("Year", "Share.from.solar" ,"PV.capacity", "PV.price", "Capita.solar.spain", "Capita.nuclear", "Capita.wind", "Capita.coal", "Capita.fossil", "Capita.gas", "Capita.oil", "Capita.solar.germany", "Capita.solar.usa", "Capita.solar.china", "Capita.solar.australia", "Capita.solar.india", "Capita.solar.world", "Generation.spain", "Generation.germany", "Generation.usa", "Generation.china", "Generation.australia", "Generation.india", "Generation.world")

rownames(df) <- df$Year
```

# EDA

```{r results = 'asis'}
str(df)
summary(df)
```

```{r results = 'asis'}

df2 <- df[25:57,]

png(file="plots/consumption_countries.png", width=14,height=12,units="cm", res=1200, pointsize=6)
plot(df2$Year, df2$Capita.solar.india, type = "o", col = 6, ylim = c(1,2000), xlab="Year", ylab="Consumption (kWh)", main="Per capita solar energy consumption", cex.lab = 1.5, cex.main = 1.8, pch = 16)
lines(df2$Year, df2$Capita.solar.china, type = "b", col = 3, pch = 16)
lines(df2$Year, df2$Capita.solar.germany, type = "b", col = 1, pch = 16)
lines(df2$Year, df2$Capita.solar.world, type = "b", col = 7, pch = 16)
lines(df2$Year, df2$Capita.solar.australia, type = "b", col = 5, pch = 16)
lines(df2$Year, df2$Capita.solar.spain, type = "b", col = 2, pch = 16)
lines(df2$Year, df2$Capita.solar.usa, type = "b", col = 4, pch = 16)
legend(1990, 2000, legend=c("Spain", "China", "Germany", "USA", "Australia",
                       "India", "World"),
       col=c(2,3,1,4,5,6,7),  lty = 1, cex=1.5, lwd = 3)
dev.off()


png(file="plots/generation.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df2$Year, df2$Generation.world, type = "o", col = 7, ylim = c(1,350), xlab="Year", ylab="Generation (TWh)", main= "Solar power generation", cex.lab = 1.5, cex.main = 1.8, pch = 16)
lines(df2$Year, df2$Generation.china, type = "b", col = 3, pch = 16)
lines(df2$Year, df2$Generation.germany, type = "b", col = 1, pch = 16)
lines(df2$Year, df2$Generation.spain, type = "b", col = 2, pch = 16)
lines(df2$Year, df2$Generation.australia, type = "b", col = 5, pch = 16)
lines(df2$Year, df2$Generation.india, type = "b", col = 6, pch = 16)
lines(df2$Year, df2$Generation.usa, type = "b", col = 4, pch = 16)
legend(1990, 350, legend=c("Spain", "China", "Germany", "USA", "Australia",
                       "India", "World"),
       col=c(2,3,1,4,5,6,7), lty = 1, cex=1.5, lwd = 3)
dev.off()


png(file="plots/consumption_energies.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df2$Year, df2$Capita.solar.spain, type = "o", col = 7, ylim = c(1,25000), xlab="Year",ylab = "Consumption (kWh)", main ="Per capita different energies consumption", cex.lab = 1.5, cex.main = 1.8, pch = 16)
lines(df2$Year, df2$Capita.oil, type = "o", col = 2, pch = 16)
lines(df2$Year, df2$Capita.nuclear, type = "o", col = 3, pch = 16)
lines(df2$Year, df2$Capita.gas, type = "o", col = 6, pch = 16)
lines(df2$Year, df2$Capita.wind, type = "o", col = 4, pch = 16)
lines(df2$Year, df2$Capita.coal, type = "o", col = 1, pch = 16)
legend("topright", legend=c("Solar", "Wind", "Nuclear", "Coal", "Gas","Oil"),
       col=c(7,4,3,1,6,2),  lty = 1, cex=1, lwd = 3)
dev.off()



png(file="plots/prices.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df2$Year, df2$PV.price, type = "o", col = 7, xlab="Year", ylab = "Price (($/W))", main="Solar PV module prices", lwd = 1.5, cex.lab = 1.5, cex.main = 1.8, pch = 16)
dev.off()

png(file="plots/capacity.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df2$Year, df2$PV.capacity, type = "o", col = 7, xlab="Year", ylab = "Capacity (GW)", main ="Solar PV capacity", lwd = 1.5, cex.lab = 1.5, cex.main = 1.8, pch = 16)
dev.off()

png(file="plots/share.png", width=14,height=12,units="cm", res=1200, pointsize=6)
plot(df2$Year, df2$PV.capacity, type = "o", col = 7, xlab="Year", ylab = "Share (%)", main ="Share of electricity production from solar", lwd = 1.5, cex.lab = 1.5, cex.main = 1.8, pch = 16)
dev.off()

```


# Apply stuff from the lectures

Take the column we want to study in depth (per capita solar energy consumption in Spain)

```{r results = 'asis'}

cap_solar_SP <- df$Capita.solar.spain[25:57] #25 because first data start there

```

Plot the data and the autocorrelation plot.

```{r results = 'asis'}

plot(x = df$Year[25:57], cap_solar_SP,  xlab="Year", ylab="Per capita consumption (kWh)", type= "b",  pch=16, lty=3, cex=0.6) #from 1989 to 2021
plot(cumsum(cap_solar_SP), x = df$Year[25:57], type="b", xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex=0.6)

acf1 <- acf(cap_solar_SP)
plot(acf1, xlab = "Lag", main = "Autocorrelation of solar consumption", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)

```

## LM

```{r Cap_solar_SP linear regression, results=}

##fit a linear regression model (Just to check is not good)
m_lm <- lm(cap_solar_SP ~ df$Year[25:57])
summary(m_lm)

##plot of the model
plot(df$Year[25:57], cap_solar_SP, xlab="Year", ylab="Per capita consumption (kWh)", type= "b", pch=16, lty=3, cex=0.6)
abline(m_lm, lwd=2, col=3)

##Test of DW
dwtest(m_lm) #0.199 so strong positive autocorrelation 

##check the residuals
res_lm<- residuals(m_lm)
plot(df$Year[25:57], res_lm, xlab="Year", ylab="Residuals (kWh)", type= "b",  pch=16, lty=3, cex=0.6)


```

## TsLM


```{r , results=}

# Works pretty bad because it only models the trend

# convert to time series
cap_solar_SP.ts <- ts(cap_solar_SP)

# Model
m_tslm <- tslm(cap_solar_SP.ts~trend)
summary(m_tslm)

# Calculate fitted values and plot them
fit <- fitted(m_tslm)
plot(cap_solar_SP.ts, xlab="Year", ylab="Per capita consumption (kWh)", type= "b", pch=16, lty=3, cex=0.6)
lines(fitted(m_tslm), lwd = 2, col = 2)

# Do a forecast and plot it
fore <- forecast(m_tslm)
plot(fore, xlab="Year", ylab="Per capita consumption (kWh)", xaxt ='n',type= "b", pch=16, lty=3, cex=0.6)
axis(1, at = seq(1, 42, by=5), labels=seq(1989, 2030, by=5))


# Calculate residuals and plot them
res <- residuals(m_tslm)
plot(df$Year[25:57], res_lm, xlab="Time", ylab="Residuals (kWh)", type= "b",  pch=16, lty=3, cex=0.6)

# Lets us calculate the autocorrelation function of the residuals
res1 <- Acf(res)
plot(res1, xlab = "Lag", main = "Autocorrelation of residuals", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)


 # DW test
dwtest(m_tslm)

#########
```

# Bass Model

Let's now fit a Bass model.

```{r cap_solar_SP Base Model (BM), results=}

bm_SP<-BM(cap_solar_SP,display = T)
summary(bm_SP)

dwtest(bm_SP)

###prediction (out-of-sample)
pred_bm_SP<- predict(bm_SP, newx=c(1:50))
pred.inst_SP<- make.instantaneous(pred_bm_SP)

###plot of fitted model 
plot(x = df$Year[25:57], cap_solar_SP, type= "b",xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex=0.6)
lines(x = c(1989:2022), pred.inst_SP[1:34], lwd=2, col=2)

###Analysis of residuals

res_BM_SP<- residuals(bm_SP)
plot(res.BM_SP, xlab="Year", ylab="Residuals (kWh)", type= "b",  pch=16, lty=3, cex=0.6)


```


Let's see what happens when we estimate the model with 75 percent of the data.

```{r results = 'asis'}

bm_SP75<-BM(cap_solar_SP[1:25],display = T)
summary(bm_SP75)

# prediction
pred_bm_SP75<- predict(bm_SP75, newx=c(1:50))
pred.inst_SP75<- make.instantaneous(pred_bm_SP75)

# plotting
plot(x = df$Year[25:57], cap_solar_SP, type= "b",xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex=0.6)
lines(x = c(1989:2022), pred.inst_SP75[1:34], lwd=2, col=2)

```


Plot both models to compare them. 

```{r results = 'asis'}

###Comparison between models (instantaneous)
###instantaneous
png(file="plots/bassmodel.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(x = df$Year[25:57], cap_solar_SP, type= "b",xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex.lab = 1.5)
lines(x = c(1989:2022), pred.inst_SP75[1:34], lwd=2, col=2)
lines(x = c(1989:2022), pred.inst_SP[1:34], lwd=2, col=7)
legend("topleft", legend=c("Data", "BM", "BM 75%"),
       col=c(1,7,2),  lty = 1, cex=1.5, lwd = 3)
dev.off()


###Comparison between models (cumulative)
plot(x = df$Year[25:57], cumsum(cap_solar_SP), type= "b",xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex=0.6)
lines(x = c(1989:2022), pred_bm_SP75[1:34], lwd=2, col=2)
lines(x = c(1989:2022), pred_bm_SP[1:34], lwd=2, col=4)
legend("topleft", legend=c("Data", "BM", "BM 75%"),
       col=c(1,2,4),  lty = 1, cex=1.2, lwd = 3)

```

# Generalized bass model

```{r cap_solar_SP GBM, results=}

GBM_SP_e2 <- GBM(cap_solar_SP, shock = "exp", nshock = 2, prelimestimates = c(1.243162e+04, 2.424655e-05, 3.283666e-01, 19, -0.1,0.2, 29,0.2,0.4), display=TRUE) 
summary(GBM_SP_e2)


pred_GBM_SP_e2<- predict(GBM_SP_e2, newx=c(1:50))
pred_GBM_SP_e2.inst<- make.instantaneous(pred_GBM_SP_e2)

png(file="plots/gbm.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(x = df$Year[25:57], cap_solar_SP, type= "b", xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex.lab=1.5, xlim=c(1989,2025), ylim=c(0,2200))
lines(x = c(1989:2023), pred_GBM_SP_e2.inst[1:35], lwd=2, col=7)
dev.off()

fit_GBM_SP<- fitted(GBM_SP_e2)
fit_GBM_SP_inst<- make.instantaneous(fit_GBM_SP)
plot(x = df$Year[25:57], cap_solar_SP, xlab="Year", ylab="Per capita consumption (kWh)",type= "b",pch=16, lty=3, cex=0.6)
lines(x = c(1989:2021), fit_GBM_SP_inst, lwd=2, col=2)

```

```{r results = 'asis'}

###Analysis of residuals
res_GBM_SP<- residuals(GBM_SP_e2)
res2 <- acf(res_GBM_SP)

plot(res2, xlab = "Lag", main = "Autocorrelation of residuals", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)

plot(res_GBM_SP, xlab="Year", ylab="Residuals (kWh)", type= "b",  pch=16, lty=3, cex=0.6)

  
```

# GGM

```{r cap_solar_SP GGM, results=}

GGM_SP<- GGM(cap_solar_SP, prelimestimates=c(1.243162e+04, 0.01, 0.01,  2.424655e-05, 3.283666e-01))
summary(GGM_SP)

pred_GGM_SP<- predict(GGM_SP, newx=c(1:60))
pred_GGM_SP.inst<- make.instantaneous(pred_GGM_SP)

png(file="plots/ggm.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(x = df$Year[25:57], cap_solar_SP, type= "b", xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex.lab=1.5, xlim=c(1989,2030), ylim=c(0,2700))
lines(x = c(1989:2030), pred_GGM_SP.inst[1:42], lwd=2, col=7)
dev.off()

fit_GGM_SP<- fitted(GGM_SP)
fit_GGM_SP_inst<- make.instantaneous(fit_GGM_SP)
plot(x = df$Year[25:57], cap_solar_SP, xlab="Year", ylab="Per capita consumption (kWh)", type= "b",pch=16, lty=3, cex=0.6)
lines(x = c(1989:2021), fit_GGM_SP_inst, lwd=2, col=2)
```


```{r results = 'asis'}

###Analysis of residuals
res_GGM_SP<- residuals(GGM_SP)
plot(res_GGM_SP)
res3 <- acf(residuals(GGM_SP))

plot(res3, xlab = "Lag", main = "Autocorrelation of residuals", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)

plot(res_GGM_SP, xlab="Year", ylab="Residuals (kWh)", type= "b",  pch=16, lty=3, cex=0.6)

```


```{r results = 'asis'}

### Comparison between BM, GBM and GGM

png(file="plots/comp_bm_gbm_ggm.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(x = df$Year[25:57], cap_solar_SP, type= "o", xlab="Year", ylab="Per capita consumption (kWh)", pch=16, lty=1, cex.lab=1.5, xlim=c(1989,2023), ylim=c(0,2700))
lines(x = c(1989:2023), pred_GGM_SP.inst[1:35], lwd=2, col=7)
lines(x = c(1989:2023), pred_GBM_SP_e2.inst[1:35], lwd=2, col=4)
lines(x = c(1989:2023), pred.inst_SP[1:35], lwd=2, col=2)
legend("topleft", legend=c("Data", "BM", "GBM with two exp. shocks", "GGM"),
       col=c(1,2,4,7),  lty = 1, cex=1.2, lwd = 3)
#main = "Per capita solar energy consumption - model comparison",
dev.off()

###Comparaison of residuals between BM, GBM and GGM
png(file="plots/res_comp_bm_gbm_ggm.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(x = c(1:33), res_GGM_SP,lwd=2, col=7, type= "l", xlab="Year", ylab="Residuals (kWh)", pch=16, lty=1, cex.lab=1.5 ,xlim=c(0,33), ylim=c(-500,500))
lines(x = c(1:33), res_GBM_SP, lwd=2, col=4)
lines(x = c(1:33), res_BM_SP, lwd=2, col=2)
legend("topleft", legend=c("BM", "GBM with two exp. shocks", "GGM"),
       col=c(2,4,7),  lty = 1, cex=1.2, lwd = 3)
#main = "Residuals distribution - model comparison",
dev.off()


```



# Arima

```{r cap_solar_SP Arima, results=}

plot(x = df$Year[25:57],cap_solar_SP, type= "b", xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex=0.6)


acf2 <- Acf(cap_solar_SP)
png(file="plots/acf_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(acf2, xlab = "Lag", ylab = "ACF", main = "Autocorrelation of solar consumption", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)
dev.off()


pacf <- Pacf(cap_solar_SP)
png(file="plots/pacf_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(pacf, xlab = "Lag", ylab = "Partial ACF", main = "Partial autocorrelation of solar consumption", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)
dev.off()

```

Own Arima, delete? First solve problem with auto arima (0,2,0)

```{r results = 'asis'}
# Fit Arima model
arima1<- Arima(cap_solar_SP, order=c(2,1, 0))
fitted(arima1)

# See effect of differenciation 
diff1<- diff(cap_solar_SP) ##first difference
diff2<- diff(cap_solar_SP, lag=2)
tsdisplay(diff1)
tsdisplay(diff2)


# Analyze residuals
resid1<- residuals(arima1)
tsdisplay(resid1)

# Plot Arima model
plot(x = df$Year[25:57], cap_solar_SP, xlab="Year", ylab="Per capita consumption (kWh)", type= "b", pch=16, lty=3, cex=0.6)
lines(x = c(1989:2022), fitted(arima1)[1:34], lwd =2, col=2)

# Forecast
for1<- forecast(arima1, 5)
plot(for1, xaxt = 'n', xlab="Year", ylab="Per capita consumption (kWh)", type= "b", pch=16, lty=3, cex.lab=1.5)
axis(1, at = seq(1, 38, by=5), labels=seq(1989, 2026, by=5))
lines(fitted(arima1)[1:34], lwd =2, col=7)

```


Auto arima

```{r cap_solar_SP Autoarima, results=}

# Try autoarima
auto.a <- auto.arima(cap_solar_SP)
auto.a

# Plot fitting
plot(x = df$Year[25:57], cap_solar_SP, xlab="Year", ylab="Per capita consumption (kWh)", type= "b", pch=16, lty=3, cex=0.6)
lines(x = c(1989:2022), fitted(auto.a)[1:34], lwd =2, col=2)

# Do forecast
plot(forecast(auto.a, 5), xaxt='n', xlab="Year", ylab="Per capita consumption (kWh)", type= "b", pch=16, lty=3, cex.lab =1.5)
axis(1, at = seq(1, 38, by=5), labels=seq(1989, 2026, by=5))
lines(fitted(auto.a)[1:34], col=7)

#Check residuals
checkresiduals(auto.a)



####SARMAX refinement
####SARMAX model with external covariate 'fit_GGM_SP' 
auto_with_reg <- auto.arima(cap_solar_SP, xreg = pred_GGM_SP.inst[1:33])
auto_with_reg
summary(auto_with_reg)

plot(df$Year[25:57],cap_solar_SP, type= "o",xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=1, cex=0.6, col = 1)
lines(df$Year[25:57], pred_GGM_SP.inst[1:33], lwd=2, lty=1, col = 2)
lines(df$Year[25:57], fitted(auto_with_reg), lty=1,lwd=2, col=7)
legend("topleft", legend=c("Data", "GGM", "Auto ARIMA with xreg"),
       col=c(1,2,7),  lty = 1, cex=1.5, lwd = 3)


png(file="plots/autoarima_xreg_ggm.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(forecast(auto_with_reg, xreg = pred_GGM_SP.inst[34:39]), xaxt='n', xlab="Year", ylab="Per capita consumption (kWh)", type= "b", pch=16, lty=3, cex.lab=1.5)
axis(1, at = seq(1, 34, by=5), labels=seq(1989, 2022, by=5))
lines(pred_GGM_SP.inst[1:33], lwd=2, lty=1, col = 2)
lines(fitted(auto_with_reg), lty=1,lwd=2, col=7)
legend("topleft", legend=c("Data", "GGM", "Auto ARIMA with xreg"),
       col=c(1,2,7),  lty = 1, cex=1.5, lwd = 3)
dev.off()


####SARMAX refinement
####SARMAX model with external covariate 'fit_GBM_SP' 
auto_with_reg <- auto.arima(cap_solar_SP, xreg = pred_GBM_SP_e2.inst[1:33])
auto_with_reg
summary(auto_with_reg)

plot(df$Year[25:57],cap_solar_SP, type= "o",xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=1, cex.lab=1.5, col = 1)
lines(df$Year[25:57], pred_GBM_SP_e2.inst[1:33], lwd=2, lty=1, col = 2)
lines(df$Year[25:57], fitted(auto_with_reg), lty=1,lwd=2, col=7)
legend("topleft", legend=c("Data", "GBM", "Auto ARIMA with xreg"),
       col=c(1,2,7),  lty = 1, cex=1.2, lwd = 3)

plot(forecast(auto_with_reg, xreg = pred_GBM_SP_e2.inst[34:35]), xaxt='n', type= "b", xlab="Year", ylab="Per capita consumption (kWh)",  pch=16, lty=3, cex=0.6, col = 1)
axis(1, at = seq(1, 42, by=5), labels=seq(1989, 2030, by=5))

```


# Influence of external regressors

## All countries

```{r countries influence on cap_solar_SP, results=}

xreg <- cbind(Germany=df$Capita.solar.germany[25:57], 
              China=df$Capita.solar.china[25:57],
              USA=df$Capita.solar.usa[25:57],
              India=df$Capita.solar.india[25:57])

armax_all_countries <- auto.arima(cap_solar_SP, xreg = xreg)
summary(armax_all_countries)
# Residuals
res_all_countries <- residuals(armax_all_countries)

res4 <- Acf(res_all_countries)
plot(res4, xlab = "Lag", main = "Autocorrelation of residuals", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)

fitted_all_countries <- fitted(armax_all_countries)

plot(df$Year[25:57], cap_solar_SP, type= "b", xlab="Year", ylab="Per capita consumption (kWh)", pch=16, lty=3, cex=0.6)
lines(df$Year[25:57],fitted_all_countries,  lwd=2,col = 2)

```

## Countries + price + capacity + share
 
 

```{r all influence on cap_solar_SP, results=}

# Let's see the influence of the solar energy consumption in China over the one in Spain


xreg <- cbind(Germany=df$Capita.solar.germany[25:54], 
              China=df$Capita.solar.china[25:54],
              USA=df$Capita.solar.usa[25:54],
              India=df$Capita.solar.india[25:54],
              Price = df$PV.price[25:54],
              Capacity = df$PV.capacity[25:54],
              Share = df$Share.from.solar[25:54])

armax_all <- auto.arima(cap_solar_SP[1:30], xreg = xreg)
summary(armax_all)
# Residuals
res_all <- residuals(armax_all)
res5 <- Acf(res_all)
plot(res5, xlab = "Lag", main = "Autocorrelation of residuals", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)

fitted_all <- fitted(armax_all)

plot(df$Year[25:54], cap_solar_SP[1:30], type= "b", xlab="Year", ylab="Per capita consumption (kWh)", pch=16, lty=3, cex=0.6)
lines(df$Year[25:54],fitted_all, lwd = 2, col = 2)


xreg_forecast <- cbind(Germany=df$Capita.solar.germany[54:57], 
                 China=df$Capita.solar.china[54:57],
                 USA=df$Capita.solar.usa[54:57],
                 India=df$Capita.solar.india[54:57],
                 Price = df$PV.price[54:57],
                 Capacity = df$PV.capacity[54:57],
                 Share = df$Share.from.solar[54:57])


# Do forecast
plot(forecast(armax_all, xreg = xreg_forecast), xaxt='n', type= "b", xlab="Year", ylab="Per capita consumption (kWh)", pch=16, lty=3, cex=0.6)
axis(1, at = seq(1, 34, by=5), labels=seq(1989, 2022, by=5))



############################# If not to forecast: ##############################

xreg <- cbind(Germany=df$Capita.solar.germany[25:57], 
              China=df$Capita.solar.china[25:57],
              USA=df$Capita.solar.usa[25:57],
              India=df$Capita.solar.india[25:57],
              Price = df$PV.price[25:57],
              Capacity = df$PV.capacity[25:57],
              Share = df$Share.from.solar[25:57])

armax_all <- auto.arima(cap_solar_SP, xreg = xreg)
summary(armax_all)
# Residuals
res_all <- residuals(armax_all)
res6 <- Acf(res_all)

plot(res6, xlab = "Lag", main = "Autocorrelation of residuals", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)

fitted_all <- fitted(armax_all)

plot(df$Year[25:57], cap_solar_SP, type= "b", xlab="Year", ylab="Per capita consumption (kWh)", pch=16, lty=3, cex=0.6)
lines(df$Year[25:57],fitted_all, lwd =2, col = 2)

```


# Study of influence of certain countries

```{r Installed solar capacity of spain vs world, results=}
#Inspecting if the installed solar energy capacity of Spain is influenced by the one of another country.

df_capacity_transformed <- df_capacity

#Create one columns per country, with years as row and solar capacity as value
df_capacity_transformed <-  dcast(df_capacity_transformed, Year ~ Entity) 

#remove all white space in name columns
names(df_capacity_transformed) <- gsub(" ", ".", names(df_capacity_transformed))

#Keep only countries
df_capacity_transformed <- df_capacity_transformed %>% select(-c("Africa.(BP)", "Africa", "Asia", "Asia.Pacific.(BP)", "CIS.(BP)","Europe", "Europe.(BP)", "High-income.countries", "Lower-middle-income.countries", "Middle.East.(BP)", "North.America.(BP)", "Other.Africa.(BP)", "Other.Asia.Pacific.(BP)", "Other.CIS.(BP)", "Other.Europe.(BP)", "Other.Middle.East.(BP)", "Other.South.and.Central.America.(BP)", "South.and.Central.America.(BP)", "United.Arab.Emirates", "North.America", "South.America", "South.Africa", "Upper-middle-income.countries", "World", "Oceania" ))

df_capacity_transformed[is.na(df_capacity_transformed)] <- 0 #Convert NA to 0


## Using Pearson correlation, Spain vs all

cor_spain_vs_all <- cor(df_capacity_transformed[ , colnames(df_capacity_transformed) != "Spain"], df_capacity_transformed$Spain)
cor_spain_vs_all #Portugal with 0.9449656, Belgium 0.9423068 and Australia 0.9409159 are the country with higher Pearson correlation. 


## Get the residuals after fitting arima model

auto.arima.spain <- auto.arima(df_capacity_transformed$Spain)
res.spain = residuals(auto.arima.spain)
acf(df_capacity_transformed$Spain)
acf(res.spain)

auto.arima.portugal <- auto.arima(df_capacity_transformed$Portugal)
res.portugal = residuals(auto.arima.portugal)
acf(df_capacity_transformed$Portugal)
acf(res.portugal)

auto.arima.germany <- auto.arima(df_capacity_transformed$Germany)
res.germany = residuals(auto.arima.germany)

auto.arima.china <- auto.arima(df_capacity_transformed$China)
res.china = residuals(auto.arima.china)

auto.arima.australia <- auto.arima(df_capacity_transformed$Australia)
res.australia = residuals(auto.arima.australia)

auto.arima.france <- auto.arima(df_capacity_transformed$France)
res.france = residuals(auto.arima.france)

auto.arima.belgium <- auto.arima(df_capacity_transformed$Belgium)
res.belgium = residuals(auto.arima.belgium)

auto.arima.usa <- auto.arima(df_capacity_transformed$United.States)
res.usa = residuals(auto.arima.usa)

auto.arima.india <- auto.arima(df_capacity_transformed$India)
res.india = residuals(auto.arima.india)


```

```{r Installed solar capacity of spain vs world2, results=}

# Check cross correlation plots of residuals for most significant countries.

png(file="plots/portugal_vs_spain.png", width=14,height=12,units="cm",res=1200, pointsize=6)
ccf_spain_portugal <- ccf(res.portugal, res.spain,10, main = "Portugal vs Spain", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8) # Spain leads Portugal (positive cross correlation at lag 2) 
dev.off()

ccf_spain_portugal <- ccf(res.usa, res.spain,10)      # Not really clear
ccf_spain_portugal <- ccf(res.belgium, res.spain,10) # Not really clear
ccf_spain_portugal <- ccf(res.australia, res.spain,10)  # Not really clear
ccf_spain_portugal <- ccf(res.china, res.spain,10)  # Not really clear
ccf_spain_portugal <- ccf(res.india, res.spain,10)  # Not really clear

png(file="plots/germany_vs_spain.png", width=14,height=12,units="cm",res=1200, pointsize=6)
ccf_spain_portugal <- ccf(res.germany, res.spain,10, main = "Germany vs Spain", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8) #Germany leads Spain (negative cross correlation at lag 6)
dev.off()

png(file="plots/france_vs_spain.png", width=14,height=12,units="cm",res=1200, pointsize=6)
ccf_spain_portugal <- ccf(res.france, res.spain,10, main = "France vs Spain", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8) # Spain leads France (positive cross correlation at lag 2) 
dev.off()

```

# Model Price-Capacity relation


```{r Relationship capacity vs PV modul price, results=}

y <-  df$PV.price[32:57]
x <-  df$PV.capacity[32:57] #[32:57] to avoid 0 values of df_capacity

#ACF
acf(x, 15)
acf(y, 15)
ccf(x, y,15)

#Fit linear regression model
fit1 <- lm(y ~ x)
summary(fit1)
#summary analysis: Residual: average price of 4.34 for Solar PV modul. For an increase of 1 gigawatts, the price of PV modul drop of 0.50241usd$ per watts with a variation of 0.06389usd$ per watts. T-value significantly bigger than zero and their standard-errors, indicating that the coefficients are relatively bigger enough from their standart-errors. P-value smaller than 5% and three start, thus p-value significant enough to reject null hypothesis which mean there is a relationship between solar capacity and solar PV modul price. The residual standard error is 1.115, which represent 1.115/4.34312= 25.6% deviation error. R-squared of 0.7204, which mean that 72% of the variance of the solar PV modul price can be described by the solar capacity. F-Statistic larger than 1 significantly for 24 DF, meaning strong indication we can reject null hypothesis of no relationship.

##Plot of the model
plot(x, y, xlab="Capacity (GW)", ylab="Price ($/W)")
abline(fit1, col=3) 

##Check the residuals? are they auto correlated? Test of DW
dwtest(fit1) #reject null hypothesis, thus they are auto correlated.

##check the residuals
resfit<- residuals(fit1) 
plot(resfit,xlab="Solar Capacity", ylab="residuals" )


###################
###Local regression
###################
y <-  df$PV.price[32:57]
x <-  df$PV.capacity[32:57]
plot(x,y,xlab="Capacity (GW)", ylab="Price ($/W)")

sm.regression(x, y, h= 5, add= T)

#lets increase the number of points where the function is calculated
sm.regression(x, y, h= 5, add= T, ngrid=200,col=1)

#Trying different value for h: higher h = smoother function.
sm.regression(x, y,   h = 4, ngrid=200, col=2)
sm.regression(x, y,   h = 3, add = T, ngrid=200, col=3) # Choose this one
sm.regression(x, y,   h = 2,  add = T, ngrid=200, col=4)
sm.regression(x, y,   h = 1,  add = T, col=5, ngrid=200)

#We add variability bands
sm.regression(x, y,   h = 3, ngrid=200, display="se")

#####################
###Loess (Locally Weighted Least Squares Regression). it uses more local data to estimate our Y variable. But it is also known as a variable bandwidth smoother, in that it uses a 'nearest neighbors' method to smooth.
#####################

plot(x,y, xlab="Capacity (GW)", ylab="Price ($/W)")
lo1 <- loess.smooth(x,y) 
lines(lo1) #default span = 0.75
lo2 <- loess.smooth(x,y,span=0.9)
lines(lo2,col=2)
lo3 <- loess.smooth(x,y,span=0.4) 
lines(lo3,col=3)

#another way to perform loess, performs directly the plot
#default span= 2/3
scatter.smooth(x,y) 
scatter.smooth(x,y, span=0.3)
scatter.smooth(x,y, span=0.3, evaluation=200)  ########### I wouldn't take any loess result because it gives negative values for the price

#####################
###Regression splines (cubic splines)
#####################

#We select and identify the knots 'equispaced'
xi<-seq(min(x), max(x), length=4)

# Model (2 internal knots)
m1cc<-lm(y ~ bs(x, knots=xi[2:(length(xi)-1)], degree=3))

###---- for graphical reasons select 200 points where to evaluate the model
xxx<-seq(min(x),max(x),length=200)

#Make predictions by using the 'xxx' points
fit1<-predict(m1cc, data.frame(x=xxx))
plot(x,y,xlab="Capacity (GW)", ylab="Price ($/W)")
lines(xxx,fit1,col=2)

######vertical line to indicate the knots
abline(v=xi[2], lty=3)
abline(v=xi[3], lty=3)

### Selecting number of knots
plot(x,y,xlab="Solar capacity", ylab="Solar PV modul price")


# Model with 1 internal knots 
m3cc <- lm(y ~ bs(x, df=4, degree=3)) 
fit3<-predict(m3cc,data.frame(x=xxx))
lines(xxx,fit3,col=2)

# Model with 5 internal knots 
m3cc <- lm(y ~ bs(x, df=8, degree=3))  # Choose this one
fit3<-predict(m3cc,data.frame(x=xxx))
lines(xxx,fit3,col=7)


# Model with 2 internal knots
m1cc<-lm(y~bs(x, df=5, degree=3)) 
fit1<-predict(m1cc, data.frame(x=xxx)) ########## not good, gives negative values for price, also with 3 and 4 knots
lines(xxx,fit1,col=4) 

# Model with no internal knots 
m2cc <- lm(y ~ bs(x, df=3, degree=3)) 
fit2<-predict(m2cc,data.frame(x=xxx))  ############# not good, too simple
lines(xxx,fit2,col=3)



####################
###Smoothing splines
####################

plot(x,y,xlab="Capacity (GW)", ylab="Price ($/W)")

# Model 1
s1 <- smooth.spline(x,y, lambda=0.0001) # gives negative values for price
p1<- predict(s1, x=xxx)
lines(p1, col=2)

# Model 2
s2 <- smooth.spline(x,y, lambda=0.001)  ## Choose this one
p2<- predict(s2, x=xxx)
lines(p2, col=7)

# Model 3
s3 <- smooth.spline(x,y, lambda=0.01)  # A bit simple
p3<- predict(s3, x=xxx)
lines(p3, col=4)

# Model 4
s4 <- smooth.spline(x,y, lambda=0.1) # too simple
p4<- predict(s4, x=xxx)
lines(p4, col=3)


```



```{r Price vs capacity plot with loca regression, regression spline and smoothing, results=}

# Show local regression, regression spline, smoothing spline in one plot

png(file="plots/price_vs_capacity.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(x,y,xlab="Capacity (GW)", ylab="Price ($/W)", lwd = 2, cex.lab = 1.5, pch=16)
sm.regression(x, y,   h = 3, add = T, ngrid=200, col=2, lwd = 2)
lines(xxx,fit3,col=3, lwd = 2)
lines(p2, col=4, lwd = 2)
legend("topright", legend=c("Local regression", "Regression spline", "Smoothig spline"),
       col=c(2,3,4), lty = 1, cex=1.5, lwd = 3)
# main = "Modelling price of PV cells as a function of their capacity"
dev.off()

```




# Modelling competition between different energies


```{r Study different energy consumption, results=}
#####Study of consumption of solar vs nuclear, wind, fossil, gas, oil, coal.

SS <- df$Capita.solar.spain[25:57]
SN <- df$Capita.nuclear[4:57]
SW <- df$Capita.wind[25:57]
SF <- df$Capita.fossil[1:57]
SG <- df$Capita.gas[5:57]
SO <- df$Capita.oil[1:57]
SC <- df$Capita.coal[1:57]

```



```{r competition between solar and nuclear, results=}
##Competition between solar and nuclear

ucrcdNS <-UCRCD(SN,SS, display=T, m2 = 12431) 
summary(ucrcdNS)

png(file="plots/nuclear_vs_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(year, SN, xlab="Year", ylab="Consumption per capita (kWh)", type="b",pch=16, lty=3, cex.lab=1.5, col = 1)
points(df$capita_solar_spain$Year[25:57],SS, type= "b", pch=16, lty=3, cex=0.7, col=7)
lines(year, (ucrcdNS$fitted.i[[1]]), lwd=2, col=1)
lines(df$Year[25:57], (ucrcdNS$fitted.i[[2]]), lwd=2, col=2)
abline(v=1989, lty=2)
legend("topleft", legend=c("Nuclear", "Solar"),
       col=c(1,7), lty = 1, cex=1.5, lwd = 3)
dev.off()


```



```{r results = 'asis'}
#competition between solar and wind

ucrcdWS <-  UCRCD(SW,SS, display=T)
summary(ucrcdWS)

png(file="plots/wind_vs_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(capita_wind$Year[25:57], SW, xlab="Year", ylab="Consumption per capita (kWh)", type="b",pch=16, lty=3, cex.lab=1.5, col = 1)
points(capita_solar_spain$Year[25:57], SS, type= "b", pch=16, lty=3, col=7)
lines(capita_wind$Year[25:57], (ucrcdWS$fitted.i[[1]]), lwd=2, col=1)
lines(capita_solar_spain$Year[25:57], (ucrcdWS$fitted.i[[2]]), lwd=2, col=7)
legend("topleft", legend=c("Wind", "Solar"),
       col=c(1,7), lty = 1, cex=1.5, lwd = 3)
dev.off()

```



```{r results = 'asis'}
#competition between solar and fossil

ucrcdFS <-  UCRCD(SF,SS, display=T)
summary(ucrcdFS)

png(file="plots/fossils_vs_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df$Year[1:57], SF, xlab="Year", ylab="Consumption per capita (kWh)", type="b",pch=16, lty=3, cex=0.7, ylim = c(0,35000), col = 1, cex.lab = 1.5)
points(df$Year[25:57],SS, type= "b", pch=16, lty=3, col=7)
lines(df$Year[1:57], (ucrcdFS$fitted.i[[1]]), lwd=2, col=1)
lines(df$Year[25:57], (ucrcdFS$fitted.i[[2]]), lwd=2, col=7)
abline(v=1989, lty=2)
legend("topleft", legend=c("Fossils", "Solar"),
       col=c(1,7), lty = 1, cex=1.5, lwd = 3)
dev.off()

```




```{r results = 'asis'}

#competition between solar and oil

ucrcdOS <- UCRCD(SO,SS, display=T)
summary(ucrcdOS)

png(file="plots/oil_vs_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df$Year[1:57], SO, xlab="Year", ylab="Consumption per capita (kWh)", type="b",pch=16, lty=3, cex.lab=1.5, ylim = c(0,21000), col = 1)
points(df$Year[25:57],SS, type= "b", pch=16, lty=3, col=7)
lines(df$Year[1:57], (ucrcdOS$fitted.i[[1]]), lwd=2, col=1)
lines(df$Year[25:57], (ucrcdOS$fitted.i[[2]]), lwd=2, col=7)
abline(v=1989, lty=2)
legend("topleft", legend=c("Oil", "Solar"),
       col=c(1,7), lty = 1, cex=1.5, lwd = 3)
dev.off()

```



```{r results = 'asis'}

#competition between solar and gas

ucrcdGS <-  UCRCD(SG,SS, display=T)
summary(ucrcdGS)

png(file="plots/gas_vs_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df$Year[5:57], SG, xlab="year", ylab="Consumption per capita (kWh)", type="b",pch=16, lty=3, cex.lab=1.5, col = 1)
points(df$Year[25:57],SS, type= "b", pch=16, lty=3, col=7)
lines(df$Year[5:57], (ucrcdGS$fitted.i[[1]]), lwd=2, col=1)
lines(df$Year[25:57], (ucrcdGS$fitted.i[[2]]), lwd=2, col=7)
abline(v=1989, lty=2)
legend("topleft", legend=c("Gas", "Solar"),
       col=c(1,7), lty = 1, cex=1.5, lwd = 3)
dev.off()

```



```{r results = 'asis'}

#competition between solar and coal

ucrcdCS <- UCRCD(SC,SS, display=T)
summary(ucrcdCS)

png(file="plots/coal_vs_solar.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(df$Year[1:57], SC, xlab="Year", ylab="Consumption per capita (kWh)", type="b",pch=16, lty=3, cex.lab=1.5,  ylim = c(0,6500), col = 1)
points(df$Year[25:57],SS, type= "b", pch=16, lty=3, col=7)
lines(df$Year[1:57], (ucrcdCS$fitted.i[[1]]), lwd=2, col=1)
lines(df$Year[25:57], (ucrcdCS$fitted.i[[2]]), lwd=2, col=7)
abline(v=1989, lty=2)
legend("topleft", legend=c("Coal", "Solar"),
       col=c(1,7), lty = 1, cex=1.5, lwd = 3)
dev.off()

```


# Gam


```{r results = 'asis'}

###############################################################################
# Part of GAM #################################################################
###############################################################################

set.seed(1)
data <- df[25:57,1:16]

# #transform variable year in format "date"
# data$Year <- as.Date(data$Year, "%Y")

# Plot histograms of the variables
par(mfrow=c(4,4))
for(i in c(1:14)){
  hist(data[,i], col="orange", main=paste(colnames(data)[i]), xlab="")
}

# Based on the histograms change some variables to logarithmic?

#Let's check correlations
par(mfrow=c(1,1))
corr_coef <- cor(data, use="complete.obs")
round(corr_coef,2)
png(file="plots/correlation.png", width=14,height=12,units="cm",res=1200, pointsize=6)
ggcorrplot(corr_coef, hc.order = TRUE, type = "lower", lab = TRUE, tl.cex = 8, lab_size = 2, legend.title = "Correlation", colors = c("#CC0000", "white", "#FEDE00") ) +
theme(legend.title = element_text(size = 10))
dev.off()

# Train-test split
train = sample(1:nrow(data), 0.7*nrow(data))
data.train=data[train ,]
data.test=data[-train ,]

##########################
####Linear Model#########
#########################

# Try full linear model first
m1 <- lm(Capita.solar.spain ~ . - Capita.fossil, data=data.train)
summary(m1)
AIC(m1)

pred.lm1 <- predict(m1, newdata=data.test)
deviance.lm1 <- sum((pred.lm1 - data.test$Capita.solar.spain)^2)
deviance.lm1
mse.lm1 <- mean((pred.lm1 - data.test$Capita.solar.spain)^2)
mse.lm1


# Try stepwise regression to reduce the number of features
m2 <- step(m1, direction="both") # both backward and forward selection together.
summary(m2)
AIC(m2)

pred.lm2 <- predict(m2, newdata=data.test)
deviance.lm2 <- sum((pred.lm2 - data.test$Capita.solar.spain)^2)
deviance.lm2
mse.lm2 <- mean((pred.lm2 - data.test$Capita.solar.spain)^2)
mse.lm2

##########################
####GAM Model#########
#########################

#Start with a linear model (df=1)
gamodel <- gam(Capita.solar.spain ~ . - Capita.fossil, data=data.train)
summary(gamodel)
AIC(gamodel)


#Show the linear effects 
par(mfrow=c(3,5))
plot(gamodel, se=T)

#Perform stepwise selection using gam scope
#Values for df should be greater than 1, with df=1 implying a linear fit

sc = gam.scope(data.train[,-c(5,9)], response=5, smoother = "s", arg=c("df=2","df=3","df=4")) # arg specifies some degrees of freedom (df = 1 linear fit...)
gamscope<- step.Gam(gamodel, scope=sc, trace=T, direction = c("both"))
sc2 = gam.scope(data.train[,-c(5,9)], response=5, smoother = "lo", arg=c("df=2","df=3","df=4")) # loess smoother
gamscope2<- step.Gam(gamodel, scope=sc2, trace=T, direction = c("both"))


summary(gamscope)
AIC(gamscope)

summary(gamscope2)
AIC(gamscope2)

# smoothing splines work a bit better than loess

# # par(mfrow=c(3,4))
# # plot(gamscope, se=T)
# 
# # # if we want to see better some plot (1, 2)
# # par(mfrow=c(1,1))
# # plot(gamscope, se=T, ask=T)


#Prediction

# Predictions of splines
pred.gam <- predict(gamscope,newdata=data.test)     
dev.gam <- sum((pred.gam - data.test$Capita.solar.spain)^2)
dev.gam
mse.gam <- mean((pred.gam - data.test$Capita.solar.spain)^2)
mse.gam

# Predictions of loess smoother
pred.gam2 <- predict(gamscope2,newdata=data.test)     
dev.gam2 <- sum((pred.gam2 - data.test$Capita.solar.spain)^2)
dev.gam2
mse.gam2 <- mean((pred.gam2 - data.test$Capita.solar.spain)^2)
mse.gam2

# Residual analysis
png(file="plots/residuals_gam.png", width=14,height=12,units="cm",res=1200, pointsize=6)
tsdisplay(residuals(gamscope), main = "Residuals of GAM with smoothing splines", col = 7, lwd = 4, ci.col = 7, cex.lab = 1.5, cex.main = 1.8)
dev.off()

aar1<- auto.arima(residuals(gamscope))
plot(data.train$Capita.solar.spain, type="l")
lines(fitted(aar1)+ fitted(gamscope), col=4)


+++
```




```{r results = 'asis'}

# Try bulding own gam model

gam.m1 = gam(Capita.solar.spain ~ s(Capita.solar.china ,2) + s(Capita.gas,4) - Capita.fossil ,data= data.train)
gam.m2 = gam(Capita.solar.spain ~ s(Capita.solar.china ,2) + s(Capita.gas,4) + lo(Share.from.solar, 3) - Capita.fossil , data= data.train )
gam.m3 = gam(Capita.solar.spain ~ s(Capita.solar.china ,2) + s(Capita.gas,4) + lo(Share.from.solar, 3) + lo(Capita.fossil, df = 2) - Capita.fossil, data= data.train)
gam.m4 = gam(Capita.solar.spain ~ s(Capita.solar.china ,2) + s(Capita.gas,4) + lo(Share.from.solar, 3) + lo(Capita.fossil, df = 2) + Capita.nuclear - Capita.fossil, data= data.train)
gam.m5 = gam(Capita.solar.spain ~ s(Capita.solar.china ,2) + s(Capita.gas,4) + lo(Share.from.solar, 3) + lo(Capita.fossil, df = 2) + Capita.nuclear + Capita.wind - Capita.fossil , data= data.train)
gam.m6 = gam(Capita.solar.spain ~ s(Capita.solar.china ,2) + s(Capita.gas,4) + lo(Share.from.solar, 3) + lo(Capita.fossil, df = 2) + Capita.nuclear + Capita.wind + Capita.oil - Capita.fossil , data= data.train)

anova (gam.m1 , gam.m2 , gam.m3, gam.m4 , gam.m5 , gam.m6 ,test ="F")

summary(gam.m3)
AIC(gam.m1)
AIC(gam.m2)
AIC(gam.m3)
AIC(gam.m4)
AIC(gam.m5)
AIC(gam.m6)
AIC(gamscope)

# AIC of scopegam with smoothing splines still lower

```

# Gradient boosting


```{r results = 'asis'}

###############################################################################
# Part of Gradient boosting################################################################
###############################################################################

################################
###### CART #######
################################


#
set.seed(123)
cb1 <- sample(1:NROW(data.train),20)
cb2 <- setdiff(1:NROW(data.train),cb1) #takes those elements of data.train not present in cb1

#splitting
t1a <- tree(Capita.solar.spain ~ ., data=data.train[cb1,], control=tree.control(nobs=length(cb1), minsize=2, mindev=0))

plot(t1a)
text(t1a, cex=0.5)

#pruning
t1b <- prune.tree(t1a, newdata=data.train[cb2,])
plot(t1b)


J <- t1b$size[which.min(t1b$dev)]


t1c <- prune.tree(t1a, best=J)

plot(t1c)
text(t1c, pretty=4, cex=0.7)

#
#Prediction

# make some variables factor
p.tree <- predict(t1c,newdata=data.test)     
mse.tree <- mean((p.tree-data.test$Capita.solar.spain)^2)
mse.tree




```




```{r results = 'asis'}
################################
###### Gradient Boosting #######
################################

# 1 Boosting- 
boost.capita = gbm(Capita.solar.spain ~ . - Capita.fossil, data=data.train, 
                 distribution="gaussian", n.trees=500, interaction.depth=1, bag.fraction = 0.95)

#for the plot
par(mfrow=c(1,1))

#plot of training error
plot(boost.capita$train.error, type="l", ylab="training error")#always decreasing with increasing number of trees

# Feature importance plot
par(mai=mai.new)
summary(boost.capita, las=1, cBar=10) 
par(mai=mai.old)



# test set prediction for every tree (1:500)
yhat.boost=predict(boost.capita, newdata=data.test, n.trees=1:500)

# calculate the error for each iteration
#use 'apply' to perform a 'cycle for' 
# the first element is the matrix we want to use, 2 means 'by column', 
#and the third element indicates the function we want to calculate

err = apply(yhat.boost, 2, function(pred) mean((data.test$Capita.solar.spain - pred)^2))
#
plot(err, type="l")

# error comparison (train e test)
plot(boost.capita$train.error, type="l", col = 1, lwd = 2, ylab = "Error", xlab = "Number of trees", cex.lab = 1.5)
lines(err, type="l", col=7, lwd = 2)
legend("topright", legend=c("Train", "Test"),
       col=c(1,7),  lty = 1, cex=1.5, lwd = 3)

#minimum error in test set
best=which.min(err)
abline(v=best, lty=2, col=2)
#
min(err) #minimum error


# 2 Boosting - Deeper trees
boost.capita.deeper=gbm(Capita.solar.spain ~ . - Capita.fossil, data=data.train, 
                 distribution="gaussian", n.trees=500, interaction.depth=4, bag.fraction = 0.95)

plot(boost.capita.deeper$train.error, type="l")

#par(mai=mai.new)

summary(boost.capita.deeper, las=1, cBar=10)  

#par(mai=mai.old)

yhat.boost=predict(boost.capita.deeper ,newdata=data.test,n.trees=1:500)
err = apply(yhat.boost,2, function(pred) mean((data.test$Capita.solar.spain-pred)^2))
plot(err, type="l")


plot(boost.capita.deeper$train.error, type="l")
lines(err, type="l", col=2)
best=which.min(err)
abline(v=best, lty=2, col=4)
min(err)


# 3 Boosting - Smaller learning rate 

boost.capita.lr=gbm(Capita.solar.spain ~ . - Capita.fossil, data=data.train, bag.fraction = 0.95, 
                 distribution="gaussian", n.trees=500, interaction.depth=1, shrinkage=0.01)
plot(boost.capita.lr$train.error, type="l")

par(mai=mai.new)

summary(boost.capita.lr, las=1, cBar=10) 
par(mai=mai.old)

yhat.boost=predict(boost.capita.lr ,newdata=data.test,n.trees=1:500)
err = apply(yhat.boost,2,function(pred) mean((data.test$Capita.solar.spain-pred)^2))
plot(err, type="l")


plot(boost.capita.lr$train.error, type="l")
lines(err, type="l", col=2)
best=which.min(err)
abline(v=best, lty=2, col=4)
min(err)


# 4 Boosting - combination of previous models
boost.capita.comb=gbm(Capita.solar.spain ~ . - Capita.fossil,data=data.train, bag.fraction = 0.95,
                 distribution="gaussian",n.trees=5000, interaction.depth=2, shrinkage=0.01)

plot(boost.capita.comb$train.error, type="l")
#

par(mai=mai.new)

png(file="plots/boosting_importances.png", width=14,height=12,units="cm",res=1200, pointsize=6)
mai.old<-par()$mai
mai.old
#new vector
mai.new<-mai.old
#new space on the left
mai.new[2] <- 1
mai.new
#modify graphical parameters
par(mai=mai.new)
# summary(boost.capita, las=1) 
#las=1 horizontal names on y
summary(boost.capita.comb, las=1, cBar=10, cex.lab = 1.5, cex.names = 1.1) # cbar to say how many variables in the plot
#back to original window
par(mai=mai.old)
dev.off()

par(mai=mai.old)

yhat.boost=predict(boost.capita.comb ,newdata=data.test,n.trees=1:5000)
err = apply(yhat.boost, 2, function(pred) mean((data.test$Capita.solar.spain-pred)^2))
plot(err, type="l")

png(file="plots/train_test.png", width=14,height=12,units="cm",res=1200, pointsize=6)
plot(boost.capita.comb$train.error, type="l", col = 1, lwd = 2, ylab = "Error", xlab = "Number of trees", cex.lab = 1.5)
lines(err, type="l", col=7, lwd = 2)
legend("topright", legend=c("Train", "Test"),
       col=c(1,7),  lty = 1, cex=2, lwd = 3)
dev.off()
best=which.min(err)
abline(v=best, lty=2, col=4)
err.boost= min(err)
err.boost

boost.capita.comb
# partial dependence plots
plot(boost.capita.comb, i.var=1, n.trees = best)
plot(boost.capita.comb, i.var=2, n.trees = best)
plot(boost.capita.comb, i.var=3, n.trees = best)
plot(boost.capita.comb, i.var=c(1,5), n.trees = best) #bivariate (library(viridis) may be necessary)
#
plot(boost.capita.comb, i.var=4, n.trees = best) # categorical
plot(boost.capita.comb, i.var=5, n.trees = best)

plot(boost.capita.comb, i=6, n.trees = best)# categorical
plot(boost.capita.comb, i=7, n.trees = best) #no effect
plot(boost.capita.comb, i=8, n.trees = best)# categorical
plot(boost.capita.comb, i=9, n.trees = best) #no effect
plot(boost.capita.comb, i=10, n.trees = best)# categorical
plot(boost.capita.comb, i=11, n.trees = best) #no effect
plot(boost.capita.comb, i=12, n.trees = best)# categorical
plot(boost.capita.comb, i=13, n.trees = best) #no effect



```




```{r results = 'asis'}

################################
###### Random Forest ###########
################################

set.seed (1)


# Bagging
rf.capita.b= randomForest(Capita.solar.spain ~ . - Capita.fossil, data=data.train , mtry = 15, importance = TRUE, ntree = 250) # All 13 predictors considered = bagging is done

yhat.rf.b = predict(rf.capita.b , newdata = data.test)
plot( yhat.rf.b , data.test$Capita.solar.spain)
abline (0 ,1)
err.b <- mean (( yhat.rf.b - data.test$Capita.solar.spain)^2)
err.b


# Random Forest
rf.capita= randomForest(Capita.solar.spain ~ . - Capita.fossil, data=data.train , mtry = 6, importance = TRUE, ntree = 200)

yhat.rf = predict(rf.capita , newdata = data.test)
plot( yhat.rf , data.test$Capita.solar.spain)
abline (0 ,1)
err <- mean (( yhat.rf - data.test$Capita.solar.spain)^2)
err

```



