---
title: "Evolution of solar energy production and use."
author: "Laia Porcar, Luis Marcos LÃ³pez, Philippe Robert"
date: "11/08/2022"
output:
  html_document:
    keep_md: yes
    toc: yes
    df_print: kable
  pdf_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(warn=-1)

```



```{r, results="hide", message = FALSE}
# Installs
# install.packages("caret")
# install.packages("car")
# install.packages("ggplot2")
# install.packages("devtools")  


# Libraries
library(knitr)
library(tidyverse)
library(ggplot2)
library(dplyr)
library(ggcorrplot)
library(devtools) 
library(caret)
library(car)
library(kableExtra)
library(ggpubr)
library(readxl)
library(lmtest) 
library(forecast)
library(DIMORA)
library(reshape2)
library(zoo)


```

# Read and prepare datasets

```{r results = 'asis'}
# Read the dataset
file_path <- getwd()
paste(file_path)


# Per capita energy consumption from solar
df_capita_solar <- read.csv(paste0(file_path, "/per-capita-solar.csv"),header=TRUE)
# Solar PV module prices
df_price <- read.csv(paste0(file_path, "/solar-pv-prices.csv"),header=TRUE)
# Share of electricity production from solar
df_share <- read.csv(paste0(file_path, "/share-electricity-solar.csv"),header=TRUE)
# Installed solar energy capacity
df_capacity <- read.csv(paste0(file_path, "/installed-solar-PV-capacity.csv"),header=TRUE)
# Per capita energy consumption from nuclear
df_capita_nuclear <- read.csv(paste0(file_path, "/per-capita-nuclear.csv"),header=TRUE)
# Per capita energy consumption from wind
df_capita_wind <- read.csv(paste0(file_path, "/per-capita-wind.csv"),header=TRUE)
# Per capita energy consumption from fossil
df_capita_fossil <- read.csv(paste0(file_path, "/fossil-fuels-per-capita.csv"),header=TRUE)
# Per capita energy consumption from oil
df_capita_oil <- read.csv(paste0(file_path, "/per-capita-oil.csv"),header=TRUE)
# Per capita energy consumption from gas
df_capita_gas <- read.csv(paste0(file_path, "/per-capita-gas.csv"),header=TRUE)
# Per capita energy consumption from coal
df_capita_coal <- read.csv(paste0(file_path, "/coal-consumption-per-capita.csv"),header=TRUE)


# df_capacity[1:50,] %>%
#   kable(format = "html", col.names = colnames(df_capacity)) %>%
#   kable_styling() %>%
#   kableExtra::scroll_box(width = "100%", height = "300px")


```


```{r results = 'asis'}

entity <- 'Spain'



share <- df_share %>% filter(Entity == entity) %>% select(-c(Entity, Code))
price <- select(df_price,-c(Entity, Code))
capacity <- df_capacity %>% filter(Entity == entity) %>% select(-c(Entity, Code))

capita_solar_spain <- df_capita_solar %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_nuclear <- df_capita_nuclear %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_wind <- df_capita_wind %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_fossil <- df_capita_fossil %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_gas <- df_capita_gas %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_oil <- df_capita_oil %>% filter(Entity == entity) %>% select(-c(Entity, Code))
capita_coal <- df_capita_coal %>% filter(Entity == entity) %>% select(-c(Entity, Code))

capita_solar_germany <- df_capita_solar %>% filter(Entity == 'Germany') %>% select(-c(Entity, Code))
capita_solar_usa <- df_capita_solar %>% filter(Entity == 'United States') %>% select(-c(Entity, Code))
capita_solar_china <- df_capita_solar %>% filter(Entity == 'China') %>% select(-c(Entity, Code))





df <- merge(share, capacity, by="Year", all = TRUE) #to fill the non existent values with NA
df <- merge(df,price,by="Year", all = TRUE)
df <- merge(df,capita_solar_spain,by="Year", all = TRUE)
df <- merge(df,capita_nuclear,by="Year", all = TRUE)
df <- merge(df,capita_wind,by="Year", all = TRUE)
df <- merge(df,capita_coal,by="Year", all = TRUE)
df <- merge(df,capita_fossil,by="Year", all = TRUE)
df <- merge(df,capita_gas,by="Year", all = TRUE)
df <- merge(df,capita_oil,by="Year", all = TRUE)
df <- merge(df,capita_solar_germany,by="Year", all = TRUE)
df <- merge(df,capita_solar_usa,by="Year", all = TRUE)
df <- merge(df,capita_solar_china,by="Year", all = TRUE)

df[is.na(df)] <- 0 #change NA to 0

# # # Change names of columns
colnames(df) <- c("Year", "Share.from.solar" ,"PV.capacity", "PV.price", "Capita.solar.spain", "Capita.nuclear", "Capita.wind", "Capita.coal", "Capita.fossil", "Capita.gas", "Capita.oil", "Capita.solar.germany", "Capita.solar.usa", "Capita.solar.china")


```


# Apply stuff from the lectures

Check some info of the data

```{r results = 'asis'}

str(df) #str() is an alternative to summary() but more compact

```


Take the column we want to study in depth (per capita solar energy consumption in Spain)

```{r results = 'asis'}

cap_consump <- df$Solar.per.capita..kWh...equivalent[25:57] #25 because first data start there
tt<- 1:NROW(cap_consump)

```

Plot the data and the autocorrelation plot.

```{r results = 'asis'}

plot(tt, cap_consump, xlab="Time", ylab="Solar per capita kWh") #from 1989 to 2021
acf(cap_consump) #strong correlation with lag values, correlation is negative after 10 years.


```



```{r results = 'asis'}

##fit a linear regression model           (not sur if useful method)
fit1 <- lm(cap_consump ~ tt)
summary(fit1)

##plot of the model
plot(tt, cap_consump, xlab="Time", ylab="Solar per capita kWh")
abline(fit1, col=3)

##check the residuals? are they autocorrelated? Test of DW
dwtest(fit1)

##check the residuals
resfit1<- residuals(fit1)
plot(resfit1,xlab="Time", ylab="residuals" )


```



```{r results = 'asis'}

##let us do the same with a linear model for time series, so we transform the data into a ts object
cap_consump.ts <- ts(cap_consump)
ts.plot(cap_consump.ts, type="o")

## we fit a linear model with the tslm function
fitts<- tslm(cap_consump.ts~trend)

###obviously it gives the same results of the first model
summary(fitts)

dwtest(fitts)

```



```{r results = 'asis'}

#plot(cap_consump, type="b")
plot(cap_consump, type= "b",xlab="Year", ylab="Solar per capita kWh",  pch=16, lty=3, xaxt="n", cex=0.6)
plot(cumsum(cap_consump), type="b", xlab="Year", ylab="Solar per capita kWh",  pch=16, lty=3, xaxt="n", cex=0.6)

```

# Bass Model

Let's now fit a Bass model.

```{r results = 'asis'}

bm_cap<-BM(cap_consump,display = T)
summary(bm_cap)

###prediction (out-of-sample)
pred_bmcap<- predict(bm_cap, newx=c(1:50))
pred.instcap<- make.instantaneous(pred_bmcap)

###plot of fitted model 
plot(cap_consump, type= "b",xlab="Year", ylab="Solar per capita kWh",  pch=16, lty=3, xaxt="n", cex=0.6)
lines(pred.instcap, lwd=2, col=2)

```

Predict (out-of-sample).

```{r results = 'asis'}

pred_bmcap<- predict(bm_cap, newx=c(1:50))
pred.instcap<- make.instantaneous(pred_bmcap)

```

Plot of fitted model

```{r results = 'asis'}

### 
plot(cap_consump, type= "b",xlab="Year", ylab="Solar per capita kWh",  pch=16, lty=3, xaxt="n", cex=0.6)
lines(pred.instcap, lwd=2, col=2)

```


Let's see what happens when we estimate the model with 75 percent of the data.

```{r results = 'asis'}

bm_cap75<-BM(cap_consump[1:25],display = T)
summary(bm_cap75)

# prediction
pred_bmcap75<- predict(bm_cap75, newx=c(1:50))
pred.instcap75<- make.instantaneous(pred_bmcap75)

# plotting
plot(cap_consump, type= "b",xlab="Year", ylab="Solar per capita kWh",  pch=16, lty=3, xaxt="n", cex=0.6)
lines(pred.instcap75, lwd=2, col=2)

```


Plot both models to compare them. 

```{r results = 'asis'}

###Comparison between models (instantaneous)
###instantaneous
plot(cap_consump, type= "b",xlab="Year", ylab="Solar per capita kWh",  pch=16, lty=3, xaxt="n", cex=0.6)
lines(pred.instcap75, lwd=2, col=2)
lines(pred.instcap, lwd=2, col=4)

###Comparison between models (cumulative)
plot(cumsum(cap_consump), type= "b",xlab="Year", ylab="Annual sales",  pch=16, lty=3, xaxt="n", cex=0.6)
lines(pred_bmcap75, lwd=2, col=2)
lines(pred_bmcap, lwd=2, col=4)

```

# Generalized bass model

```{r results = 'asis'}


 
# GBMe2 <- GBM(cap_consump,shock = "exp",nshock = 2,prelimestimates = c(1.243162e+04, 2.424655e-05, 3.283666e-01, 20, -0.1,0.2, 30,0.5,0.6))
# 
# GBMe2 <- GBM(cap_consump,shock = "exp",nshock = 2,prelimestimates = c(1.243162e+04, 2.424655e-05, 3.283666e-01, 20, -0.1,0.2, 30,0.5,0.7))


GBMe2 <- GBM(cap_consump,shock = "exp",nshock = 2,prelimestimates = c(1.243162e+04, 2.424655e-05, 3.283666e-01, 19, -0.1,0.2, 29,0.2,0.4))
summary(GBMe2)


# Try with three shocks
# GBMe2 <- GBM(cap_consump,shock = "exp",nshock = 3,prelimestimates = c(1.243162e+04, 2.424655e-05, 3.283666e-01, 18,-0.6,0.3, 21, -0.4,0.4, 29,0.38,0.5))

###

pred_GBMe2<- predict(GBMe2, newx=c(1:50))
pred_GBMe2.inst<- make.instantaneous(pred_GBMe2)

plot(cap_consump, type= "b",xlab="Quarter", ylab="Quarterly revenues",  pch=16, lty=3, cex=0.6, xlim=c(1,60))
lines(pred_GBMe2.inst, lwd=2, col=2)




```

# GGM

```{r results = 'asis'}

######GGM 
GGM_cap<- GGM(cap_consump, prelimestimates=c(1.243162e+04, 0.01, 0.01,  2.424655e-05, 3.283666e-01))
summary(GGM_cap)

pred_GGM_cap<- predict(GGM_cap, newx=c(1:60))
pred_GGM_cap.inst<- make.instantaneous(pred_GGM_cap)

plot(cap_consump, type= "b",xlab="Quarter", ylab="Quarterly revenues",  pch=16, lty=3, cex=0.6, xlim=c(1,60))
lines(pred_GGM_cap.inst, lwd=2, col=2)

```


```{r results = 'asis'}

###Analysis of residuals
res_GGM_cap<- residuals(GGM_cap)
acf<- acf(residuals(GGM_cap))


fit_GGM_cap<- fitted(GGM_cap)
fit_GGM_cap_inst<- make.instantaneous(fit_GGM_cap)

```


# Arima

```{r results = 'asis'}

# Let's begin with Arima

# autoplot(cap_consump)

plot(cap_consump)
Acf(cap_consump)
Pacf(cap_consump)

```


```{r results = 'asis'}
# Fit Arima model
arima1<- Arima(cap_consump, order=c(2,1, 0))
fitted(arima1)

# See effect of differenciation 
diff1<- diff(cap_consump) ##first difference
diff2<- diff(cap_consump, lag=2)
tsdisplay(diff1)
tsdisplay(diff2)


# Analyze residuals
resid1<- residuals(arima1)
tsdisplay(resid1)

# Plot Arima model
plot(cap_consump)
lines(fitted(arima1), col=2)

# Forecast
for1<- forecast(arima1)
plot(for1)

```


```{r results = 'asis'}

# Try autoarima
auto.a <- auto.arima(cap_consump)
auto.a

# Plot fitting
plot(cap_consump)
lines(fitted(auto.a), col=2)

# Do forecast
autoplot(forecast(auto.a))

#Check residuals
checkresiduals(auto.a)




```



```{r results = 'asis'}
# Let's see the influence of the price of PV modules

price <- df$Solar.PV.Module.Cost..2019.US..per.W.[25:57]
plot(price)
acf(price)
pacf(price)


# armax1 <- Arima(cap_consump, xreg = price, order = c(1,1,1))
armax1 <- auto.arima(cap_consump, xreg = price)
summary(armax1)
res1 <- residuals(armax1)
Acf(res1)

fitted(armax1)
plot(cap_consump)
lines(fitted(armax1), col = 2)


```



```{r results = 'asis'}

# Let's see the influence of the capacity of PV modules

capacity <- df$Solar.Capacity.x[25:57]
capacity.ts <- ts(capacity)
# ts.plot(capacity.ts, type="o")

plot(capacity)
acf(capacity)
pacf(capacity)

armax1 <- auto.arima(cap_consump, xreg = capacity)
summary(armax1)
res1 <- residuals(armax1)
Acf(res1)

fitted(armax1)
plot(cap_consump)
lines(fitted(armax1), col = 2)


```



```{r results = 'asis'}

mod <- tslm(cap_consump.ts~trend+capacity.ts)
summary(mod)

fitted(mod)
plot(cap_consump.ts)
lines(fitted(mod), col = 2)

# Analysis of residuals - autocorelation?
plot(residuals(mod))
dw <- dwtest(mod, alt="two.sided")
tsdisplay(residuals(mod))

aar <- auto.arima(residuals(mod))
fitted(aar)

plot(cap_consump.ts)
lines(fitted(mod)+fitted(aar), col = 3)

```




```{r results = 'asis'}
#Inpecting if the installed solar energy capacity of Spain is influenced by the one of another country.

df_capac_transformed <- df_capac

#Create one columns per country, with years as row and solar capacity as value
df_capac_transformed <-  dcast(df_capac_transformed, Year ~ Entity) 

#remove all white space in name columns
names(df_capac_transformed) <- gsub(" ", ".", names(df_capac_transformed))

#Keep only countries
df_capac_transformed <- df_capac_transformed %>% select(-c("Africa.(BP)", "Asia", "Asia.Pacific.(BP)", "CIS.(BP)","Europe", "Europe.(BP)", "High-income.countries", "Lower-middle-income.countries", "Middle.East.(BP)", "North.America.(BP)", "Other.Africa.(BP)", "Other.Asia.Pacific.(BP)", "Other.CIS.(BP)", "Other.Europe.(BP)", "Other.Middle.East.(BP)", "Other.South.and.Central.America.(BP)", "South.and.Central.America.(BP)", "United.Arab.Emirates", "North.America", "South.Africa", "Upper-middle-income.countries", "World", "Oceania" ))


str((df_capac_transformed))
df_capac_transformed[is.na(df_capac_transformed)] <- 0 #Convert NA to 0

#Convert df_capac_tansformed to a time series
#df_capac_transformed.zoo <- read.zoo(df_capac_transformed)
#df_capac_transformed.ts <- as.ts(df_capac_transformed.zoo) 

#Using Pearson correlation, Spain vs all
cor_spain_vs_all <- cor(df_capac_transformed[ , colnames(df_capac_transformed) != "Spain"], df_capac_transformed$Spain)
cor_spain_vs_all #Portugal with 0.9449656, Belgium 0.9423068 and Australia 0.9409159 are the country with higher Pearson correlation. Lets look at cross-correlation function (using lagged values of these countrie to predict current value of Spain)

ccf_spain_portugal <- ccf(df_capac_transformed$Portugal, df_capac_transformed$Spain,26) 

ccf_spain_belgium <- ccf(df_capac_transformed$Belgium, df_capac_transformed$Spain,26)

ccf_spain_australia <- ccf(df_capac_transformed$Australia, df_capac_transformed$Spain,26)
#from correlogram plot, it doesnt seems like the spending of any of theses three countries in solar capacity leads to en increase in spending in solar capacity for spain. They are correlatated, but the lagged values of theses three countries doesnt have a impact of current value of Spain, and it seems that is might be the opposite. 



#plotting Cross correlation function of every countries againts spain to see if we can see if some countries spedind leads to spain spending. I am not able to plot with the columns.
ccf_spain_vs_all <- sapply(df_capac_transformed, function(col_names) ccf(col_names,df_capac_transformed$Spain,26))
#from all correlogram, no lagged values of countries seems to influence spain spending.






```





```{r results = 'asis'}
#Analyszing relationship between Installed solar energy capacity and solar PV modul price

df_price_cap <- df[32:57,] %>% select(Year, Solar.Capacity.x, Solar.PV.Module.Cost..2019.US..per.W.)

#next step I will do: perform test that we have seen in class and labs and similar to what Luis/Laia have done previously.

```





```{r results = 'asis'}




```





```{r results = 'asis'}




```





```{r results = 'asis'}




```





```{r results = 'asis'}




```





```{r results = 'asis'}




```





```{r results = 'asis'}




```




```{r results = 'asis'}




```




```{r results = 'asis'}




```




```{r results = 'asis'}




```




```{r results = 'asis'}




```
